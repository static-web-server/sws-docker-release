freebsd_instance:
  image: freebsd-12-2-release-amd64

# Test FreeBSD in a full VM on cirrus-ci.com
# The binary will be also built in 32-bit mode, but will execute on a
# 64-bit kernel and in a 64-bit environment. Our tests don't execute
# any of the system's binaries, so the environment shouldn't matter.
task:
  name: freebsd-test
  only_if: $CIRRUS_TAG == ''
  env:
    RUSTFLAGS: -Dwarnings
  setup_script:
    - pkg install -y bash curl
    - curl https://sh.rustup.rs -sSf --output rustup.sh
    - sh rustup.sh -y --profile minimal --default-toolchain stable
    - . $HOME/.cargo/env
    - rustup target add i686-unknown-freebsd
    - |
      echo "~~~~ rustc --version ~~~~"
      rustc --version
  test_script:
    - . $HOME/.cargo/env
    - cargo test --all
  i686_test_script:
    - . $HOME/.cargo/env
    - |
      cargo test --all --target i686-unknown-freebsd
  build_test_script:
    - . $HOME/.cargo/env
    - |
      cargo build --verbose

task:
  name: freebsd-release
  only_if: $CIRRUS_TAG != ''
  env:
    RUSTFLAGS: -Dwarnings
    GITHUB_TOKEN: ENCRYPTED[725b1b2f1c54a33009aac4629a848ed4564d50662e9ee6b44ad43bafa3a138322f02fd82cad20dde958664f8bc02998b]
  setup_script:
    - pkg install -y bash curl jq
    - curl https://sh.rustup.rs -sSf --output rustup.sh
    - sh rustup.sh -y --profile minimal --default-toolchain stable
    - . $HOME/.cargo/env
    - rustup target add i686-unknown-freebsd
    - |
      echo "~~~~ rustc --version ~~~~"
      rustc --version
  build_script:
    - . $HOME/.cargo/env
    - cargo build --verbose --release --target=x86_64-unknown-freebsd
    - cargo build --verbose --release --target=i686-unknown-freebsd
  archive_x86_64_script:
    - |
      . $HOME/.cargo/env
      staging="static-web-server-$CIRRUS_TAG-x86_64-unknown-freebsd"
      mkdir -p "$staging/"
      cp "target/x86_64-unknown-freebsd/release/static-web-server" "$staging/"
      cp {README.md,LICENSE-APACHE,LICENSE-MIT} "$staging/"
      tar czf "$staging.tar.gz" "$staging"
  archive_i686_script:
    - |
      . $HOME/.cargo/env
      staging="static-web-server-$CIRRUS_TAG-i686-unknown-freebsd"
      mkdir -p "$staging/"
      cp "target/i686-unknown-freebsd/release/static-web-server" "$staging/"
      cp {README.md,LICENSE-APACHE,LICENSE-MIT} "$staging/"
      tar czf "$staging.tar.gz" "$staging"
  upload_script:
    - |
      . $HOME/.cargo/env
      ./scripts/release.sh
